<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detail Alat | Virtu DigiLab</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

  <style>
    /* Buat QR tampil di tengah */
    .qr-center {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <header>
    <a href="index.html" class="home-btn">üè† Home</a>
    <h1>Detail Alat Laboratorium</h1>
  </header>

  <main>
    <div class="card">
      <div id="data">Memuat detail alat...</div>

      <div class="qr-center">
        <div id="qrcode"></div>
      </div>
    </div>
  </main>

  <footer>¬© 2025 Virtu DigiLab</footer>


  <script>
    const SHEET_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vQXfYx0A9EbttwdEODklcJe0pY3TGftGwwiqvqQswVczPXNPG3CS3Am7dYNXQVa_XSoJX3Pnd_B3AQI/pub?gid=0&single=true&output=csv";

    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const output = document.getElementById("data");

    function parseCSVLine(line) {
      const result = [];
      let cur = "";
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && line[i + 1] === '"') {
            cur += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === ',' && !inQuotes) {
          result.push(cur);
          cur = "";
        } else {
          cur += ch;
        }
      }
      result.push(cur);
      return result;
    }

    fetch(SHEET_URL)
      .then(res => res.text())
      .then(csv => {
        const lines = csv.split(/\r?\n/);

        if (lines.length < 4) {
          output.innerHTML = `<p style='color:red'>CSV tidak sesuai format.</p>`;
          return;
        }

        const headers = parseCSVLine(lines[2]).map(h => h.trim());
        const rows = lines.slice(4)
          .map(l => parseCSVLine(l))
          .filter(r => r.some(cell => cell.trim() !== ""));

        if (!id) {
          output.innerHTML = `<p style='color:red'>ID tidak ditemukan pada URL.</p>`;
          return;
        }

        // üî• SEKARANG MENCARI SERIAL NUMBER (KOLUM 6 ‚Üí r[6])
        const match = rows.find(r => (r[6] || "").trim() === id.trim());

        if (!match) {
          output.innerHTML = `<p style='color:red'>Data tidak ditemukan untuk Serial: ${id}</p>`;
          return;
        }

        let html = "<table>";
        headers.forEach((h, i) => {
          const value = (match[i] || "").trim();
          if (!h) return;

          if (h.toLowerCase().includes("link dokumen") || /sertifikat/i.test(h)) {
            if (value) {
              html += `<tr><td><b>${h}</b></td>
                       <td><a href="${value}" target="_blank">Lihat Sertifikat</a></td></tr>`;
            } else {
              html += `<tr><td><b>${h}</b></td><td>-</td></tr>`;
            }
          } else {
            html += `<tr><td><b>${h}</b></td><td>${value || "-"}</td></tr>`;
          }
        });
        html += "</table>";

        output.innerHTML = html;

        // QR CODE
        const qrContainer = document.getElementById("qrcode");
        qrContainer.innerHTML = "";
        new QRCode(qrContainer, {
          text: window.location.href,
          width: 150,
          height: 150
        });
      })
      .catch(err => {
        output.innerHTML = `<p style='color:red'>Gagal memuat data: ${err}</p>`;
      });
  </script>

</body>
</html>
